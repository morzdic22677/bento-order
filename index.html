<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µç°¡ä¾¿ç•¶è¨‚è³¼</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;500;700&family=Shippori+Mincho:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --gold: #C5A059;
            --gold-hover: #e6c575;
            --border-color: #333;
            --font-main: 'Shippori Mincho', 'Noto Serif JP', serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-color); color: var(--text-main); font-family: var(--font-main);
            line-height: 1.6; display: flex; justify-content: center; min-height: 100vh; padding: 20px 15px;
        }
        .container { width: 100%; max-width: 900px; position: relative; padding-bottom: 80px; }
        
        .border-frame {
            position: fixed; top: 15px; left: 15px; right: 15px; bottom: 15px;
            border: 1px solid var(--gold); pointer-events: none; z-index: 100; opacity: 0.2;
        }

        h1 {
            text-align: center; color: var(--gold); font-size: 2rem; margin-bottom: 30px;
            letter-spacing: 0.1em; font-weight: 500; border-bottom: 1px solid var(--gold); padding-bottom: 15px;
        }
        h2 { font-size: 1.2rem; color: var(--gold); margin-bottom: 15px; border-left: 3px solid var(--gold); padding-left: 10px; }
        
        .section { 
            background: var(--card-bg); padding: 25px 20px; margin-bottom: 25px; 
            border: 1px solid var(--border-color); border-radius: 4px; 
        }
        
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; align-items: end;}
        .input-group-4 { display: grid; grid-template-columns: 1.5fr 2fr 0.8fr 1fr; gap: 15px; margin-bottom: 20px; align-items: end;}
        .full-width { grid-column: 1 / -1; }
        
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #888; }

        input, select {
            width: 100%; background: transparent; border: none; border-bottom: 1px solid #555;
            color: var(--text-main); padding: 12px 5px; font-family: var(--font-main); font-size: 1rem; transition: all 0.3s;
            border-radius: 0; 
        }
        select option { background-color: #ffffff; color: #000000; font-weight: 500; }
        input:focus, select:focus { outline: none; border-bottom: 1px solid var(--gold); background: rgba(197, 160, 89, 0.05); }
        input[readonly] { color: var(--gold); border-bottom: 1px dashed #444; cursor: default; }

        button {
            background: transparent; color: var(--gold); border: 1px solid var(--gold); padding: 12px 20px;
            font-family: var(--font-main); cursor: pointer; font-size: 1rem; transition: all 0.3s; border-radius: 2px;
        }
        button:hover { background: var(--gold); color: var(--bg-color); box-shadow: 0 0 10px rgba(197, 160, 89, 0.3); }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- ç·¨è¼¯æ¨¡å¼å€åŸŸ (é è¨­é¡¯ç¤º) --- */
        #editShopSection { display: block; }

        /* --- é–±è®€æ¨¡å¼å€åŸŸ (é è¨­éš±è—) --- */
        #viewShopSection { display: none; text-align: center; }
        .view-shop-title { font-size: 1.8rem; color: var(--gold); margin-bottom: 10px; font-weight: bold; border-bottom: 1px dashed #333; padding-bottom: 10px; display: block;}
        .view-shop-phone { font-size: 1.2rem; color: #ccc; margin-bottom: 20px; display: block; }
        .view-shop-phone::before { content: 'TEL : '; color: var(--gold); font-size: 0.9rem; }
        .view-actions { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }

        /* --- Header æŒ‰éˆ•ç¾¤ (Edit Mode) --- */
        .shop-header { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
        .shop-input-container { flex-grow: 1; min-width: 200px; }
        .shop-btn-group { display: flex; gap: 10px; }

        /* --- æ¸…é™¤æŒ‰éˆ• --- */
        .btn-clear-shop { 
            width: auto; padding: 10px 20px; font-size: 0.9rem; 
            border-color: #663333; color: #dd6666; 
        }
        .btn-clear-shop:hover { background: #663333; color: #fff; box-shadow: none;}

        .shop-details {
            display: flex; flex-direction: column; gap: 20px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;
        }
        .shop-row { display: flex; justify-content: space-between; align-items: flex-end; gap: 15px; flex-wrap: wrap;}
        
        .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        input[type="file"] { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2; }
        .custom-file-upload {
            display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%;
            border: 1px solid var(--gold); color: var(--gold); padding: 12px 15px; font-size: 0.95rem;
            cursor: pointer; transition: all 0.3s ease; text-align: center; background: rgba(197, 160, 89, 0.05);
        }
        .file-upload-wrapper:hover .custom-file-upload { background-color: var(--gold); color: var(--bg-color); }

        /* --- åŒæ­¥çš„åº—å®¶åœ–ç‰‡ --- */
        .synced-shop-img {
            max-width: 100%; max-height: 250px; border: 1px solid var(--gold); border-radius: 8px; 
            cursor: zoom-in; object-fit: cover; margin: 0 auto; display: block;
        }

        /* --- ç‡ˆç®± Lightbox --- */
        .lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .lightbox.active { opacity: 1; pointer-events: auto; }
        .lightbox img {
            max-width: 95%; max-height: 80%; border: 2px solid var(--gold); border-radius: 5px;
            box-shadow: 0 0 20px rgba(197, 160, 89, 0.3); transform: scale(0.8); transition: transform 0.3s ease;
        }
        .lightbox.active img { transform: scale(1.5); } 

        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .order-table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 500px; }
        .order-table th, .order-table td { text-align: left; padding: 15px 10px; border-bottom: 1px solid #333; vertical-align: middle;}
        .order-table th { color: var(--gold); font-weight: normal; font-size: 0.9rem; white-space: nowrap;}
        .price-col { text-align: right !important; white-space: nowrap;}
        .center-col { text-align: center !important; }
        .qty-col { text-align: center !important; width: 50px; }
        
        .delete-btn { border: none; color: #666; padding: 10px; font-size: 1.5rem; line-height: 1; }
        .preview-container { width: 100%; display: flex; justify-content: center; margin-top: 20px; height: 0; overflow: hidden; transition: height 0.5s ease; }
        .preview-container.active { height: 250px; }
        #bentoPreview { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 1px solid #333; opacity: 0; transition: opacity 0.5s ease; }
        #bentoPreview.visible { opacity: 1; }

        input[type="checkbox"] { width: 22px; height: 22px; border: 1px solid var(--gold); cursor: pointer; }
        input[type="checkbox"]:checked { background-color: var(--gold); }

        .summary-box { display: flex; justify-content: space-between; flex-wrap: wrap; margin-top: 20px; gap: 20px;}
        .total-price { font-size: 2rem; color: var(--gold); text-align: right; line-height: 1.2;}
        #itemCountList { list-style: none; color: #aaa; font-size: 0.9rem; width: 100%; }
        #itemCountList li { display: flex; justify-content: space-between; width: 100%; margin-bottom: 8px; border-bottom: 1px dashed #333; padding-bottom: 2px;}
        #loading { text-align: center; color: #666; display: none; margin: 20px 0;}
        .paid-status { font-size: 0.9rem; text-align: right; color: #888; margin-top: 5px; }
        .paid-status span { color: var(--gold); font-weight: bold; }

        /* --- æ‰‹æ©Ÿç‰ˆ RWD å„ªåŒ– --- */
        @media (max-width: 768px) { 
            body { padding: 10px; }
            .container { padding-bottom: 60px; }
            h1 { font-size: 1.8rem; margin-bottom: 20px; }
            .section { padding: 20px 15px; }
            
            /* æ–°å¢è¨‚å–®å€å¡Šå †ç–Š */
            .input-group, .input-group-4 { grid-template-columns: 1fr; gap: 20px; }
            #addBtn, #clearBtn { width: 100%; }
            
            /* åº—å®¶ header æ‰‹æ©Ÿç‰ˆ */
            .shop-header { flex-direction: column; width: 100%; }
            .shop-input-container { width: 100%; }
            
            /* æŒ‰éˆ•ç¾¤çµ„åœ¨æ‰‹æ©Ÿä¸Šä¸¦æ’æ»¿ç‰ˆ */
            .shop-btn-group { 
                width: 100%; 
                display: flex; 
                gap: 10px; 
                margin-top: 10px; 
            }
            .shop-btn-group button {
                flex: 1; /* å„ä½” 50% */
                display: flex; justify-content: center; align-items: center;
            }

            .shop-row { flex-direction: column; align-items: stretch; }
            
            .summary-box { flex-direction: column; align-items: flex-end; }
            .preview-container.active { height: 200px; }
            
            /* é–±è®€æ¨¡å¼æ‰‹æ©Ÿç‰ˆ */
            .view-actions { flex-direction: column; gap: 10px; }
            .view-actions button { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="border-frame"></div>
    
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <img id="lightboxImg" src="">
    </div>

    <div class="container">
        <h1>ä¾†è¨‚ä¾¿ç•¶å›‰ï¼</h1>

        <!-- åº—å®¶è¨­å®šå€ -->
        <div class="section">
            <h2>åº—å®¶è³‡è¨Š</h2>
            
            <!-- 1. ç·¨è¼¯æ¨¡å¼ (Edit Mode) -->
            <div id="editShopSection">
                <div class="input-group">
                    <div class="shop-header full-width">
                        <div class="shop-input-container">
                            <label>ä¾¿ç•¶åº—åç¨±</label>
                            <input type="text" id="shopName" placeholder="è¼¸å…¥å¾Œè«‹æ¥è‘—è¼¸å…¥é›»è©±">
                        </div>
                        <div class="shop-btn-group">
                             <button class="btn-confirm" id="confirmBtn" onclick="confirmShop()">ç¢ºå®š</button>
                             <button class="btn-map" id="mapBtnEdit" onclick="openMap('edit')">ğŸ“ åœ°åœ–</button>
                        </div>
                    </div>
                </div>

                <div class="shop-details">
                    <div class="shop-row">
                        <div style="flex-grow: 1; width: 100%;">
                            <label>åº—å®¶é›»è©±</label>
                            <input type="tel" id="shopPhone" placeholder="è¼¸å…¥é›»è©±å¾Œè«‹æŒ‰ç¢ºå®š">
                        </div>
                        
                        <div style="flex-grow: 1; width: 100%;">
                             <label>èœå–®/åº—å®¶åœ–ç‰‡</label>
                             <div class="file-upload-wrapper">
                                 <div class="custom-file-upload">
                                     <span>ğŸ“· é»æ­¤é¸æ“‡åœ–ç‰‡...</span>
                                 </div>
                                 <input type="file" id="shopImageInput" accept="image/*" onchange="previewUpload(this)">
                             </div>
                             <div id="uploadFileName" style="font-size: 0.85rem; color: var(--gold); margin-top: 5px; min-height: 1.2em;"></div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #888;"></div>
                </div>
            </div>

            <!-- 2. é–±è®€æ¨¡å¼ (View Mode) - ç•¶æœ‰è³‡æ–™æ™‚é¡¯ç¤ºæ­¤å€å¡Š -->
            <div id="viewShopSection">
                <span id="viewShopName" class="view-shop-title"></span>
                <span id="viewShopPhone" class="view-shop-phone"></span>
                
                <img id="viewShopImg" class="synced-shop-img" src="" onclick="openLightbox(this.src)" alt="Menu" style="display:none;">
                
                <div class="view-actions">
                    <button class="btn-map" onclick="openMap('view')">ğŸ“ Google åœ°åœ–</button>
                    <button class="btn-clear-shop" onclick="clearShopInfo()">âœ• æ¸…é™¤åº—å®¶è³‡è¨Š</button>
                </div>
                <div style="margin-top: 15px; font-size: 0.8rem; color: #666;">(æ»¿ 600 å…ƒå¯å¤–é€)</div>
            </div>

        </div>

        <!-- è¨‚è³¼è¼¸å…¥å€ -->
        <div class="section">
            <h2>æ–°å¢è¨‚å–®</h2>
            <div class="input-group-4">
                <div>
                    <label>å§“å</label>
                    <input type="text" id="userName" placeholder="æ‚¨çš„å§“å">
                </div>
                <div>
                    <label>å“é …é¸æ“‡</label>
                    <select id="bentoSelect" onchange="updateBentoInfo()">
                        <option value="" disabled selected>è«‹é¸æ“‡ä¾¿ç•¶</option>
                        <option value="æ‹›ç‰Œæ’éª¨é£¯" data-price="100" data-img="https://placehold.co/500x300/222/c5a059?text=æ‹›ç‰Œæ’éª¨é£¯">æ‹›ç‰Œæ’éª¨é£¯</option>
                        <option value="é…¥ç‚¸é›è…¿é£¯" data-price="120" data-img="https://placehold.co/500x300/222/c5a059?text=é…¥ç‚¸é›è…¿é£¯">é…¥ç‚¸é›è…¿é£¯</option>
                        <option value="é¦™ç…é¯–é­šé£¯" data-price="110" data-img="https://placehold.co/500x300/222/c5a059?text=é¦™ç…é¯–é­šé£¯">é¦™ç…é¯–é­šé£¯</option>
                        <option value="è”¥æ²¹é›è‚‰é£¯" data-price="115" data-img="https://placehold.co/500x300/222/c5a059?text=è”¥æ²¹é›è‚‰é£¯">è”¥æ²¹é›è‚‰é£¯</option>
                        <option value="å­£ç¯€æ™‚è”¬é£¯" data-price="90"  data-img="https://placehold.co/500x300/222/c5a059?text=å­£ç¯€æ™‚è”¬é£¯(ç´ )">å­£ç¯€æ™‚è”¬é£¯ (ç´ )</option>
                    </select>
                </div>
                <div>
                    <label>æ•¸é‡</label>
                    <select id="orderQty" style="text-align: center;">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                </div>
                <div>
                    <label>å–®åƒ¹</label>
                    <input type="number" id="bentoPrice" readonly placeholder="è‡ªå‹•">
                </div>
            </div>

            <div class="preview-container" id="previewContainer">
                <img id="bentoPreview" src="" alt="ä¾¿ç•¶é è¦½">
            </div>

            <button id="addBtn" style="margin-top: 25px;">åŠ å…¥è¨‚å–®</button>
        </div>

        <!-- è¨‚å–®åˆ—è¡¨ -->
        <div class="section">
            <h2>è¨‚è³¼åˆ—è¡¨</h2>
            <p id="loading">è®€å–è³‡æ–™ä¸­...</p>
            <div class="table-responsive">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>å“é …</th>
                            <th class="qty-col">æ•¸é‡</th>
                            <th class="price-col">ç¸½é¡</th>
                            <th class="center-col">å·²ç¹³è²»</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="orderListBody"></tbody>
                </table>
            </div>
        </div>

        <!-- çµç®—å€ -->
        <div class="section">
            <h2>çµç®—</h2>
            <div class="summary-box">
                <ul id="itemCountList"></ul>
                <div>
                    <span style="display:block; text-align:right; color:#888; font-size:0.9rem;">è¨‚å–®ç¸½é‡‘é¡</span>
                    <div class="total-price" id="totalAmount">NT$ 0</div>
                    <div class="paid-status" id="paidStatus">å·²æ”¶: 0 / æœªæ”¶: 0</div>
                </div>
            </div>
            <button id="clearBtn" style="margin-top:25px; border-color: #d44; color: #d44; font-size: 0.9rem;">æ¸…é™¤æ‰€æœ‰è¨‚å–®</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, deleteDoc, updateDoc, setDoc, doc, query, orderBy, getDocs, writeBatch 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â˜…â˜…â˜… è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Firebase Config â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSyCJFi6DkepDtqWehVsX7vEIFWpyKGCPmJM",
            authDomain: "bento-order-app.firebaseapp.com",
            projectId: "bento-order-app",
            storageBucket: "bento-order-app.firebasestorage.app",
            messagingSenderId: "748393251500",
            appId: "1:748393251500:web:64e4438c4eb1b234381509"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const ORDERS_COLLECTION = "bento_orders";
        const SHOP_INFO_COLLECTION = "bento_shop_info"; 
        const SHOP_INFO_DOC_ID = "current_shop";

        // 1. è¨‚å–®ç›£è½
        const q = query(collection(db, ORDERS_COLLECTION), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            document.getElementById('loading').style.display = 'none';
            const orders = [];
            snapshot.forEach((doc) => orders.push({ id: doc.id, ...doc.data() }));
            renderOrders(orders);
        }, (error) => console.error(error));

        // 2. åº—å®¶è³‡è¨Šç›£è½ (æ±ºå®šé¡¯ç¤º ç·¨è¼¯æ¨¡å¼ or é–±è®€æ¨¡å¼)
        const shopDocRef = doc(db, SHOP_INFO_COLLECTION, SHOP_INFO_DOC_ID);
        onSnapshot(shopDocRef, (docSnapshot) => {
            const editSection = document.getElementById('editShopSection');
            const viewSection = document.getElementById('viewShopSection');

            if (docSnapshot.exists()) {
                // --- æœ‰è³‡æ–™ï¼šåˆ‡æ›åˆ°é–±è®€æ¨¡å¼ ---
                const data = docSnapshot.data();
                
                // éš±è—ç·¨è¼¯ï¼Œé¡¯ç¤ºé–±è®€
                editSection.style.display = 'none';
                viewSection.style.display = 'block';

                // å¡«å…¥é–±è®€æ¨¡å¼çš„å…§å®¹
                document.getElementById('viewShopName').innerText = data.name || "(æœªè¼¸å…¥åº—å)";
                document.getElementById('viewShopPhone').innerText = data.phone || "(ç„¡)";
                
                // åœ–ç‰‡è™•ç†
                const imgEl = document.getElementById('viewShopImg');
                if (data.imageBase64) {
                    imgEl.src = data.imageBase64;
                    imgEl.style.display = 'block';
                } else {
                    imgEl.style.display = 'none';
                }
                
                // é †ä¾¿æŠŠè³‡æ–™å›å¡«åˆ°éš±è—çš„ inputï¼Œä»¥é˜²ä½¿ç”¨è€…æ¸…é™¤å¾Œæƒ³ä¿®æ”¹
                document.getElementById('shopName').value = data.name || "";
                document.getElementById('shopPhone').value = data.phone || "";

            } else {
                // --- ç„¡è³‡æ–™ï¼šåˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼ ---
                editSection.style.display = 'block';
                viewSection.style.display = 'none';
                
                // æ¸…ç©º Edit Inputs
                document.getElementById('shopName').value = "";
                document.getElementById('shopPhone').value = "";
                document.getElementById('shopImageInput').value = "";
                document.getElementById('uploadFileName').innerText = "";
            }
        });

        // 3. é‚è¼¯èˆ‡åŠŸèƒ½
        window.previewUpload = function(input) {
            if(input.files && input.files[0]) {
                document.getElementById('uploadFileName').innerText = "å·²é¸æ“‡: " + input.files[0].name;
            } else {
                document.getElementById('uploadFileName').innerText = "";
            }
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxWidth = 800; 
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        window.confirmShop = async function() {
            const name = document.getElementById('shopName').value.trim();
            const phone = document.getElementById('shopPhone').value.trim();
            const fileInput = document.getElementById('shopImageInput');
            const btn = document.getElementById('confirmBtn');
            
            if(!name) return alert("è«‹è¼¸å…¥åº—å");

            btn.disabled = true;
            btn.innerText = "åŒæ­¥ä¸­...";

            try {
                let imageBase64 = null;
                if (fileInput.files && fileInput.files[0]) {
                    imageBase64 = await compressImage(fileInput.files[0]);
                }

                const updateData = { name: name, phone: phone };
                if (imageBase64) { updateData.imageBase64 = imageBase64; }

                // ä½¿ç”¨ merge: trueï¼Œè‹¥æ²’ä¸Šå‚³æ–°åœ–å‰‡ä¿ç•™èˆŠåœ– (é›–ç„¶ç¾åœ¨é‚è¼¯æ˜¯æ¸…é™¤æ‰æœƒå›åˆ°ç·¨è¼¯ï¼Œä½†ä¿ç•™å½ˆæ€§)
                await setDoc(doc(db, SHOP_INFO_COLLECTION, SHOP_INFO_DOC_ID), updateData, { merge: true });
                
                // æˆåŠŸå¾Œï¼ŒonSnapshot æœƒè‡ªå‹•è™•ç† UI åˆ‡æ›ï¼Œé€™è£¡ä¸éœ€è¦æ‰‹å‹• hide/show
                // åƒ…é‡ç½®ä¸Šå‚³æ¬„ä½é¡¯ç¤º
                fileInput.value = '';
                document.getElementById('uploadFileName').innerText = '';

            } catch (e) {
                console.error("åŒæ­¥å¤±æ•—", e);
                alert("åŒæ­¥å¤±æ•— (åœ–ç‰‡å¯èƒ½å¤ªå¤§)");
            } finally {
                btn.disabled = false;
                btn.innerText = "ç¢ºå®š";
            }
        };

        window.clearShopInfo = async function() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤åº—å®¶è³‡è¨Šå—ï¼Ÿ")) {
                try { await deleteDoc(doc(db, SHOP_INFO_COLLECTION, SHOP_INFO_DOC_ID)); } 
                catch (e) { console.error("æ¸…é™¤å¤±æ•—", e); }
            }
        };

        // Render & Helpers
        function renderOrders(orders) {
            const tbody = document.getElementById('orderListBody');
            tbody.innerHTML = '';
            
            let grandTotal = 0;
            let itemCounts = {};
            let paidAmount = 0;
            let unpaidAmount = 0;

            orders.forEach(order => {
                const qty = order.quantity || 1;
                const rowTotal = order.price * qty;
                grandTotal += rowTotal;
                
                if(order.isPaid) paidAmount += rowTotal;
                else unpaidAmount += rowTotal;

                itemCounts[order.item] = (itemCounts[order.item] || 0) + qty;

                const tr = document.createElement('tr');
                const rowStyle = order.isPaid ? 'opacity: 0.5;' : '';

                tr.innerHTML = `
                    <td style="${rowStyle}">${order.name}</td>
                    <td style="${rowStyle}">${order.item}</td>
                    <td class="qty-col" style="${rowStyle}">${qty}</td>
                    <td class="price-col" style="${rowStyle}">${formatNumber(rowTotal)}</td>
                    <td class="center-col">
                        <input type="checkbox" class="paid-checkbox" data-id="${order.id}" ${order.isPaid ? 'checked' : ''}>
                    </td>
                    <td style="text-align:right;">
                        <button class="delete-btn" data-id="${order.id}">Ã—</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            bindListEvents();
            updateSummary(grandTotal, paidAmount, unpaidAmount, itemCounts);
        }

        function formatNumber(num) { return num.toLocaleString('en-US'); }

        function updateSummary(total, paid, unpaid, counts) {
            document.getElementById('totalAmount').innerText = `NT$ ${formatNumber(total)}`;
            document.getElementById('paidStatus').innerHTML = `
                å·²æ”¶: <span>NT$ ${formatNumber(paid)}</span> / æœªæ”¶: <span>NT$ ${formatNumber(unpaid)}</span>
            `;
            const countList = document.getElementById('itemCountList');
            countList.innerHTML = '';
            for (const [item, count] of Object.entries(counts)) {
                const li = document.createElement('li');
                li.innerHTML = `<span>${item}</span> <span>å…± ${count} å€‹</span>`;
                countList.appendChild(li);
            }
        }

        function bindListEvents() {
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteOrder(e.target.getAttribute('data-id')));
            });
            document.querySelectorAll('.paid-checkbox').forEach(chk => {
                chk.addEventListener('change', (e) => togglePaid(e.target.getAttribute('data-id'), e.target.checked));
            });
        }

        document.getElementById('addBtn').addEventListener('click', async () => {
            const name = document.getElementById('userName').value.trim();
            const item = document.getElementById('bentoSelect').value;
            const price = parseInt(document.getElementById('bentoPrice').value);
            const qty = parseInt(document.getElementById('orderQty').value);

            if (!name || !item || isNaN(price)) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

            const btn = document.getElementById('addBtn');
            btn.disabled = true; btn.innerText = "å‚³é€ä¸­...";

            try {
                await addDoc(collection(db, ORDERS_COLLECTION), {
                    name, item, price, quantity: qty, isPaid: false, timestamp: Date.now()
                });
                document.getElementById('userName').value = ''; 
                document.getElementById('orderQty').value = "1";
            } catch (e) { console.error(e); alert("æ–°å¢å¤±æ•—"); } 
            finally { btn.disabled = false; btn.innerText = "åŠ å…¥è¨‚å–®"; }
        });

        async function deleteOrder(id) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¨‚å–®ï¼Ÿ")) await deleteDoc(doc(db, ORDERS_COLLECTION, id));
        }

        async function togglePaid(id, isPaid) {
            try { await updateDoc(doc(db, ORDERS_COLLECTION, id), { isPaid }); }
            catch(e) { console.error(e); }
        }

        document.getElementById('clearBtn').addEventListener('click', async () => {
            if(!confirm("âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨‚å–®ï¼Ÿ")) return;
            const qSnap = await getDocs(collection(db, ORDERS_COLLECTION));
            const batch = writeBatch(db);
            qSnap.forEach(d => batch.delete(d.ref));
            await batch.commit();
        });

        window.openMap = function(mode) {
            let name;
            if(mode === 'edit') {
                name = document.getElementById('shopName').value;
            } else {
                // å¾é–±è®€æ¨¡å¼çš„æ¨™é¡Œå–å€¼
                name = document.getElementById('viewShopName').innerText;
            }
            
            if(!name || name === "(æœªè¼¸å…¥åº—å)") return alert("è«‹å…ˆè¼¸å…¥åº—å");
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`, '_blank');
        }

        window.updateBentoInfo = function() {
            const select = document.getElementById('bentoSelect');
            const opt = select.options[select.selectedIndex];
            if(opt.getAttribute('data-price')) document.getElementById('bentoPrice').value = opt.getAttribute('data-price');
            
            const imgUrl = opt.getAttribute('data-img');
            const imgEl = document.getElementById('bentoPreview');
            const container = document.getElementById('previewContainer');
            if(imgUrl) {
                imgEl.classList.remove('visible');
                setTimeout(() => { imgEl.src = imgUrl; container.classList.add('active'); imgEl.onload = () => imgEl.classList.add('visible'); }, 200);
            } else {
                imgEl.classList.remove('visible'); container.classList.remove('active');
            }
        }
        
        window.openLightbox = function(src) {
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightboxImg');
            img.src = src;
            lightbox.classList.add('active');
        }
        
        window.closeLightbox = function() {
            document.getElementById('lightbox').classList.remove('active');
        }

    </script>
</body>
</html>